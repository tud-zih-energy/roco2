#!/bin/sh

source /etc/profile.d/lmod.sh
source /etc/profile.d/zih-a-lmod.sh

module purge --force
module load toolchain/system scorep scorep_metricq lo2s

echo "it is $(date)"

# openMP thread pinning
export GOMP_CPU_AFFINITY=0-23

# disable threading by openblas itself
export OPENBLAS_NUM_THREADS=1

# overwrite metricq timeout
export SCOREP_METRIC_METRICQ_PLUGIN_TIMEOUT=12h

echo "environment variables:"
echo "  GOMP_CPU_AFFINITY                    = $GOMP_CPU_AFFINITY"
echo "  SCOREP_METRIC_PLUGINS                = $SCOREP_METRIC_PLUGINS"
echo "  SCOREP_METRIC_METRICQ_PLUGIN_TIMEOUT = $SCOREP_METRIC_METRICQ_PLUGIN_TIMEOUT"

echo "executing test..."
ulimit -n 999999
elab frequency turbo

perf probe -d roco2:metrics
sudo perf probe -x ./roco2_kallisto roco2:metrics=_ZN5roco27metrics4meta5writeEmmlmmmm experiment frequency shell threads utility || exit 1

lo2s -X -t roco2:metrics -- ${CMAKE_CURRENT_BINARY_DIR}/roco2_kallisto

echo "done"
